---
lab:
  title: 使用语言服务创建语言理解模型（预览版）
ms.openlocfilehash: 92d556e50c8f5c827e16f1e5ad301d3b59c1ad6e
ms.sourcegitcommit: cb2edc850cec8390a81212d9b8f6a279d2f42b4d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/04/2022
ms.locfileid: "141368841"
---
# <a name="create-a-language-understanding-model-with-the-language-service-preview"></a>使用语言服务创建语言理解模型（预览版）

> **注意**：语言服务的对话语言理解功能目前为预览版，随时可能会发生更改。 在某些情况下，模型训练可能会失败 - 如果发生这种情况，请重试。  

语言服务使你能够定义一个对话语言理解模型，应用程序可使用该模型来解释来自用户的自然语言输入、预测用户的意向（他们想要实现的目标），以及识别应该应用该意向的任何实体  。

例如，时钟应用程序的对话语言模型应会处理如下输入：

伦敦现在几点了？

这种输入是一种语句（用户可能说出或键入的内容）示例，对于此示例，预期意向是获取特定位置（一个实体）的时间；在本例中，此位置为“伦敦”  。

> **注意**：对话语言模型的任务是预测用户的意向，并识别应用该意向的任何实体。 实际执行满足意向所需的操作不是对话语言模型的工作<u></u>。 例如，时钟应用程序可以使用对话语言模型来识别用户想要知道的伦敦时间，但随后客户端应用程序本身必须实现此逻辑才能确定正确的时间并将其呈现给用户。

## <a name="create-a-language-service-resource"></a>创建“语言服务”资源

若要创建对话语言模型，需要受支持区域中的“语言服务”资源。 在撰写本文时，仅支持美国西部 2 和西欧区域。

1. 打开 Azure 门户 (`https://portal.azure.com`)，然后使用与你的 Azure 订阅关联的 Microsoft 帐户登录。
2. 选择“&#65291;创建资源”按钮，搜索“语言”，并使用以下设置创建“语言服务”资源。

    - **功能**：使用默认功能，其中包括对话语言理解（预览版） 
    - **订阅**：Azure 订阅
    - 资源组：选择或创建一个资源组（如果使用受限制的订阅，你可能无权创建新的资源组 - 请使用提供的资源组）
    - 区域：美国西部 2 或欧洲西部
    - **名称**：输入唯一名称
    - **定价层**：选择标准 (S) 层（免费层当前不支持对话语言理解）。
    - **法律条款**：同意 
    - **负责任的 AI 声明**：同意
3. 等待部署完成，然后查看部署详细信息。

## <a name="create-a-conversational-language-understanding-project"></a>创建对话语言理解项目

现在，你已经创建了创作资源，接下来，可以使用它来创建对话语言理解项目。

1. 在新的浏览器标签页中，打开“Language Studio”门户 (`https://language.cognitive.azure.com/`)，然后使用与 Azure 订阅关联的 Microsoft 帐户登录。

2. 如果系统提示选择语言资源，请选择以下设置：

    - **Azure Directory**：包含订阅的 Azure 目录。
    - **订阅**：Azure 订阅。
    - **语言资源**：先前创建的语言资源。

3. 如果系统未提示你选择语言资源，原因可能是已经分配了不同的语言资源；在这种情况下，你应该<u></u>：

    1. 在页面顶部的栏中，单击“设置(&#9881;)”按钮。
    2. 在“设置”页上，查看“资源”选项卡。
    3. 选择刚刚创建的语言资源，然后单击“切换资源”。
    4. 在页面顶部，单击“Language Studio”以返回到 Language Studio 主页。

4. 在门户顶部的“新建”菜单中，选择“对话语言理解”。

5. 在“创建项目”对话框中，在“输入基本信息”页上输入以下详细信息，然后单击“下一步”  ：
    - **名称**：`Clock`
    - **说明**：`Natural language clock`
    - 言语主要语言：英语
    - **在项目中启用多种语言？** ：未选定

7. 在“检查并完成”页上，单击“创建”。

## <a name="create-intents"></a>创建意向

在新项目中，首先要做的是定义一些意向。

> **提示**：在处理项目时，如果系统显示了一些提示，请阅读这些提示并单击“了解”将其关闭，也可单击“全部跳过” 。

1. 在“生成架构”页的“意向”选项卡上，选择“&#65291; 添加”以添加名为 GetTime 的新意向   。

2. 单击新的“GetTime”意向进行编辑，添加以下语句作为示例用户输入：

    `what is the time?`

    `what's the time?`

    `what time is it?`

    `tell me the time`

3. 添加这些语句后，单击“保存更改”并返回到“生成架构”页 。

4. 使用以下语句添加另一个名为 GetDay 的新意向：

    `what day is it?`

    `what's the day?`

    `what is the day today?`

    `what day of the week is it?`

5. 添加并保存这些语句后，返回到“生成架构”页面，并添加另一个名为 GetDate 的新意向，其中包含以下语句 ：

    `what date is it?`

    `what's the date?`

    `what is the date today?`

    `what's today's date?`

6. 添加这些语句后，保存它们并清除语句页上的“GetDate”筛选器，这样就可以看到所有意向对应的所有语句。

## <a name="train-and-test-the-model"></a>训练和测试模型

现在你已经添加了一些意向，接下来训练语言模型，看看它是否能够通过用户输入正确预测这些意向。

1. 在左侧窗格中，选择“训练模型”页面，然后选择“开始训练作业” 。

2. 在“开始训练作业”对话框中，选择用于训练新模型的选项，将其命名为“时钟”，并确保启用了用于在训练时运行评估的选项 。 

3. 要开始训练模型的过程，请单击“训练”。

4. 训练完成后（这可能需要几分钟），作业“状态”将变为“训练成功” 。

5. 选择“查看模型详细信息”页，然后选择“时钟”模型 。 查看总体和每个意向的评估指标（精准率、召回率和 F1 分数），以及由在训练时执行的评估生成的混淆矩阵（请注意，由于样本语句数量较少，并非所有意向都可能包含在结果中）   。

    >**注意**：若要详细了解评估指标，请参阅[文档](https://docs.microsoft.com/azure/cognitive-services/language-service/conversational-language-understanding/concepts/evaluation-metrics)

5. 在“部署模型”页面上，选择“添加部署” 。

5. 在“添加部署”对话框中，选择“新建部署名称”，然后输入“生产”  

5. 选择“时钟”模型并单击“提交” 。 此部署可能需要花一些时间。

6. 部署模型后，在“测试模型”页上选择“时钟”模型 。

6. 在“测试模型: 时钟”页上的“部署名称”下拉菜单中，选择“生产” 。  

7. 输入以下文本，然后单击“运行测试”：

    `what's the time now?`

    查看返回的结果，请注意，该结果包含预测意向（应为 GetTime）以及一个置信度分数，该分数表示模型计算出预测意向的概率。 “JSON”选项卡显示每个潜在意向的对比置信度（置信度分数最高的潜在意向就是预测意向）

8. 清除文本框，然后使用以下文本运行另一个测试：

    `tell me the time`

    再次查看预测意图和置信度分数。

9. 请尝试以下内容：

    `what's the day today?`

    模型有望预测 GetDay 意图。

## <a name="add-entities"></a>添加实体

到目前为止，你已定义了一些与意图有关的简单言语。 大多数实际应用程序都包含更复杂的言语，必须从这些言语中提取特定的数据实体才能获取有关意图的更多上下文。

### <a name="add-a-learned-entity"></a>添加学习实体

最常见的一种实体是学习实体，在此实体中，模型根据示例学习识别实体值。

1. 在“语言工作室”中，返回到“生成架构”页面，然后在“实体”选项卡上选择“&#65291; 添加”以添加新实体  。

2. 在“添加实体”对话框中，输入实体名称“位置”并确保选中“学习”  。 再单击“添加实体”。

3. 创建“位置”实体后，返回到“生成架构”页面，然后在“意向”选项卡上选择“GetTime”意向   。

4. 输入以下新示例言语：

    `what time is it in London?`

5. 添加该语句后，选择“伦敦”一词，然后在出现的下拉列表中，选择“位置”以指示“伦敦”即为一个位置示例**。

6. 添加另一示例言语：

    `Tell me the time in Paris?`

7. 添加该语句后，选择“巴黎”一词，并将其映射到“位置”实体**。

8. 添加另一示例言语：

    `what's the time in New York?`

9. 添加该语句后，选择“纽约”一词，并将其映射到“位置”实体**。

10. 单击“保存更改”以保存新的语句。

### <a name="add-a-list-entity"></a>添加列表实体

在某些情况下，实体的有效值可被限制为一系列特定术语和同义词；这可帮助应用识别言语中的实体实例。

1. 在“语言工作室”中，返回到“生成架构”页面，然后在“实体”选项卡上选择“&#65291; 添加”以添加新实体  。

2. 在“添加实体”对话框中，输入实体名称“工作日”并选择“列表”实体类型  。 再单击“添加实体”。

3. 在“工作日”实体页的“列表”部分，单击“&#65291; 添加新列表”  。 然后输入以下值和同义词，并单击“保存”：

    | 列表键 | 同义词|
    |-------------------|---------|
    | 星期日 | Sun |

4. 重复上一步以添加以下列表组件：

    | 值 | 同义词|
    |-------------------|---------|
    | 星期一 | Mon |
    | 星期二 | Tue、Tues |
    | 星期三 | Wed、Weds |
    | 星期四 | Thur、Thurs |
    | 星期五 | Fri |
    | 星期六 | Sat |

5. 返回到“生成架构”页，然后在“意向”选项卡上，选择“GetDate”意向  。

6. 输入以下新示例言语：

    `what date was it on Saturday?`

7. 添加语句后，选择“星期六”一词，然后在出现的下拉列表中选择“工作日”****。

8. 添加另一示例言语：

    `what date will it be on Friday?`

9. 添加语句后，将“星期五”映射到“工作日”实体 。

10. 添加另一示例言语：

    `what will the date be on Thurs?`

11. 添加语句后，将“星期四”映射到“工作日”实体 。

12. 单击“保存更改”以保存新的语句。

### <a name="add-a-prebuilt-entity"></a>添加预生成实体

语言服务提供了一组通常在对话应用程序中使用的预生成实体。

1. 在“语言工作室”中，返回到“生成架构”页面，然后在“实体”选项卡上选择“&#65291; 添加”以添加新实体  。

2. 在“添加实体”对话框中，输入实体名称“日期”并选择“预生成”实体类型  。 再单击“添加实体”。

3. 在“日期”实体页的“预生成”部分，单击“&#65291; 添加新的预生成”  。

4. 在“选择预生成”列表中，选择“DateTime”，然后单击“保存”  。

5. 返回到“生成架构”页，然后在“意向”选项卡上，选择“GetDay”意向  。

6. 输入以下新示例言语：

    `what day was 01/01/1901?`

7. 添加语句后，选择“1901 年 1 月 1 日”，然后在出现的下拉列表中选择“日期”****。

8. 添加另一示例言语：

    `what day will it be on Dec 31st 2099?`

9. 添加语句后，将“2099 年 12 月 31 日”映射到“日期”实体 。

10. 单击“保存更改”以保存新的语句。

### <a name="retrain-the-model"></a>重新训练模型

现在，你已经修改了架构，接下来，需要重新训练并重新测试模型。

1. 在“训练模型”页上，选择“开始训练作业” 。

1. 在“开始训练作业”对话框中，选择用于覆盖现有模型的选项并指定“时钟”模型 。 确保选择了用于在训练时运行评估的选项，然后单击“训练”以训练模型；确认要覆盖现有模型。

2. 训练完成后，作业“状态”将更新为“训练已成功” 。 

2. 选择“查看模型详细信息”页，然后选择“时钟”模型 。 查看总体、每个实体和每个意向的评估指标（精准率、召回率和 F1 分数），以及由在训练时执行的评估生成的混淆矩阵（请注意，由于样本语句数量较少，并非所有意向都可能包含在结果中）   。

3. 在“部署模型”页面上，选择“添加部署” 。

3. 在“添加部署”对话框中，选择“覆盖现有部署名称”，然后选择“生产”  。

3. 选择“时钟”模型，然后单击“提交”以部署该模型 。 这可能需要一些时间。

4. 部署模型后，在“测试模型”页上，选择“时钟”模型，选择“生产”部署，然后使用以下文本对其进行测试  ：

    `what's the time in Edinburgh?`

5. 查看返回的结果，该结果应会预测“GetTime”意向和具有文本值“爱丁堡”的“位置”实体 。

6. 尝试测试以下言语：

    `what time is it in Tokyo?`
    
    `what date is it on Friday?`

    `what's the date on Weds?`

    `what day was 01/01/2020?`

    `what day will Mar 7th 2030 be?`

## <a name="use-the-model-from-a-client-app"></a>使用客户端应用中的模型

在实际项目中，你需要反复优化意图和实体、重新训练并重新测试，直到对预测性能感到满意为止。 如果对该模型进行了测试并对其预测性能感到满意，随后可以通过调用其 REST 接口在客户端应用中使用它。 在本练习中，你将使用 curl 实用工具为模型调用 REST 终结点。

1. 在“语言工作室”的“部署模型”页上，选择“时钟”模型 。 然后，单击“获取预测 URL”。

2. 在“获取预测 URL”对话框中，请注意，预测终结点的 URL 随示例请求一起显示，该示例请求包含一个 curl 命令，该命令用于将 HTTP POST 请求提交到终结点，在标头中指定语言资源的密钥，并在请求数据中包含查询和语言 。

3. 复制示例请求，并将其粘贴到首选的文本编辑器（例如记事本）中。

4. 替换以下占位符：
    - **YOUR_QUERY_HERE**：悉尼现在几点了
    - **QUERY_LANGUAGE_HERE**：EN

    该命令应类似于以下代码：

    ```
    curl -X POST "https://some-name.cognitiveservices.azure.com/language/:analyze-conversations?projectName=Clock&deploymentName=production&api-version=2021-11-01-preview" -H "Ocp-Apim-Subscription-Key: 0ab1c23de4f56..."  -H "Apim-Request-Id: 9zy8x76wv5u43...." -H "Content-Type: application/json" -d "{\"verbose\":true,\"query\":\"What's the time in Sydney?\",\"language\":\"EN\"}"
    ```

5. 打开命令提示符 (Windows) 或 bash shell (Linux/Mac)。

6. 将编辑的 curl 命令复制并粘贴到命令行接口，然后运行该命令。

7. 查看生成的 JSON，其中应包括预测的意向和实体，如下所示：

    ```
    {"query":"What's the time in Sydney?","prediction":{"topIntent":"GetTime","projectKind":"conversation","intents":[{"category":"GetTime","confidenceScore":0.9998859},{"category":"GetDate","confidenceScore":9.8372206E-05},{"category":"GetDay","confidenceScore":1.5763446E-05}],"entities":[{"category":"Location","text":"Sydney","offset":19,"length":6,"confidenceScore":1}]}}
    ```

8. 查看由模型返回的 JSON 响应，确保预测的最高评分意向是“GetTime”。

9. 将 curl 命令中的查询更改为 `What's today's date?`，然后运行该查询并查看生成的 JSON。

10. 请尝试以下查询：

    `What day will Jan 1st 2050 be?`

    `What time is it in Glasgow?`

    `What date will next Monday be?`

## <a name="export-the-project"></a>导出项目

可以使用语言工作室来开发和测试语言理解模型，但在 DevOps 的软件开发过程中，应维护可包含在持续集成和持续交付 (CI/CD) 管道中的项目的源代码管理定义。 虽然可以在代码脚本中使用语言 REST API 来创建和训练模型，但一种更简单的方法是使用门户来创建模型架构，并将其导出为可在另一语言服务实例中导入和重新训练的 .json 文件 。 这种方法使你能够使用语言工作室可视化界面的工作效率优势，同时保持应用的可移植性和可再现性。

1. 在“语言工作室”的“项目”页上，选择“时钟”项目 。 不要单击“时钟”，请选择圆圈图标以选择时钟项目。

2. 单击“&#x2913; 导出”按钮。

3. 保存生成的 Clock.json 文件（你喜欢的任何位置）。

4. 在最喜欢的代码编辑器（例如 Visual Studio Code）中打开下载的文件，以查看项目的 JSON 定义。

## <a name="more-information"></a>详细信息

若要详细了解如何使用语言服务创建对话语言理解解决方案，请参阅[语言服务文档](https://docs.microsoft.com/azure/cognitive-services/language-service/conversational-language-understanding/overview)。
